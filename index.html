<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweep & Stretch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .timer-circle {
            transition: stroke-dashoffset 1s linear, color 0.5s ease;
        }
        /* Simple spinner animation for loading */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 1.5s linear infinite;
        }
    </style>
</head>
<body class="bg-neutral-50 font-sans antialiased text-neutral-900 selection:bg-blue-200">

    <div id="app-container" class="w-full min-h-screen">
        <!-- Views will be toggled here -->
    </div>

<script>
// --- DATA & JOKES ---
const JOKES = [
  "Why did the curler bring a broom to the bar? To sweep the competition!",
  "What is a curler's favorite type of music? Heavy metal (because of the stones)!",
  "Why are curlers so good at cleaning? They always sweep the house!",
  "What did the ice say to the curling stone? You rock!",
  "I tried to make a curling joke... but it didn't have the right delivery.",
  "How do curlers stay cool? They hang out near the hack!",
  "Keep your friends close, and your curling stones closer."
];

const EXERCISE_POOL = {
  flatFeet: [
    { id: 'arch', name: "Short Foot / Arch Lifts", desc: "Sit or stand. Without curling your toes, pull the ball of your foot toward your heel to create an arch. Hold, then release.", baseTime: 30, requiresSwitch: false },
    { id: 'toe_yoga', name: "Toe Yoga", desc: "Keep your big toe down and lift the other four. Then keep the four down and lift the big toe. Great for foot control!", baseTime: 40, requiresSwitch: false },
    { id: 'calf', name: "Seated Calf Raises", desc: "Sit up tall. Push through the balls of your feet to lift your heels high. Slowly lower. Strengthens the arch and calf.", baseTime: 45, requiresSwitch: false },
  ],
  balance: [
    { id: 'single_leg', name: "Chair-Supported Single Leg Stand", desc: "Stand next to a sturdy chair. Hold the chair, lift one foot. Try to let go with one finger at a time. Wobbling is normal!", baseTime: 40, requiresSwitch: true },
    { id: 'tandem', name: "Tandem Stance (Heel-to-Toe)", desc: "Stand near a wall. Place one foot directly in front of the other, heel touching toe. Hold your balance.", baseTime: 40, requiresSwitch: true },
    { id: 'weight_shift', name: "Weight Shifts", desc: "Stand with feet hip-width. Shift your weight entirely to your right leg, pause, then to your left. Keep a chair in front of you.", baseTime: 40, requiresSwitch: false },
  ],
  hamstrings: [
    { id: 'towel', name: "Seated Towel Stretch", desc: "Sit on the floor. Loop a towel around one foot. Gently pull the towel to stretch the back of your leg. Keep your back straight.", baseTime: 60, requiresSwitch: true },
    { id: 'chair_ham', name: "Chair Hamstring Stretch", desc: "Sit on the edge of a chair. Extend one leg out straight, heel on the floor. Hinge forward slightly at the hips.", baseTime: 60, requiresSwitch: true },
    { id: 'wall_ham', name: "Wall Supported Hamstring", desc: "Lie on your back near a doorway. Put one leg straight up the wall/doorframe, the other through the door. Relax.", baseTime: 60, requiresSwitch: true },
  ],
  hips: [
    { id: 'figure4', name: "Seated Figure 4", desc: "Sit in a chair. Cross your right ankle over your left knee. Gently press the right knee down or lean forward slightly.", baseTime: 60, requiresSwitch: true },
    { id: 'kneel_lunge', name: "Kneeling Lunge Stretch", desc: "Kneel on a soft pillow. Step one foot forward so your knee is at 90 degrees. Gently shift weight forward. Hold a wall!", baseTime: 60, requiresSwitch: true },
  ],
  curling: [
    { id: 'broom', name: "The Broom Twist", desc: "Sit or stand holding a broom (or imaginary broom) across your shoulders. Gently twist your torso side to side.", baseTime: 45, requiresSwitch: false },
    { id: 'slider', name: "Supported Slider Lunge", desc: "Hold a chair. Step one foot back and drop your hips slightly into a mini-lunge, mimicking a curling slide. Don't go deep!", baseTime: 40, requiresSwitch: true },
  ]
};

// --- SVG ASSETS ---
const ICONS = {
    play: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`,
    pause: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,
    chevronRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
    refresh: `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transform rotate-45"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10"></path><path d="M3.51 15A9 9 0 0 0 18.36 18.36L23 14"></path></svg>`,
    checkCircle: `<svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
    smile: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>`,
    sparkles: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>`,
    loader: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin-slow"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`,
    arrowRightLeft: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 3 4 4-4 4"></path><path d="M20 7H4"></path><path d="m8 21-4-4 4-4"></path><path d="M4 17h16"></path></svg>`,
    info: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
};

function getSketchPath(id) {
    switch(id) {
      case 'arch': return '<path d="M 20 80 Q 45 65 70 80 L 85 90 L 15 90 Z" />';
      case 'toe_yoga': return '<path d="M 20 85 L 50 85 L 75 70 M 50 85 L 80 80 M 50 85 L 85 90" />';
      case 'calf': return '<rect x="15" y="45" width="25" height="40" stroke="none" fill="#e2e8f0" /><circle cx="30" cy="15" r="8" /><path d="M 30 23 L 30 50 M 30 50 L 55 50 M 55 50 L 55 80 M 55 80 L 70 95" />';
      case 'single_leg': return '<rect x="70" y="40" width="15" height="50" stroke="none" fill="#e2e8f0" /><circle cx="40" cy="15" r="8" /><path d="M 40 23 L 40 55 M 40 55 L 40 90 M 40 55 L 55 55 M 55 55 L 55 80 M 40 35 L 70 45 M 40 35 L 20 50" />';
      case 'tandem': return '<circle cx="50" cy="15" r="8" /><path d="M 50 23 L 50 60 M 50 60 L 35 90 M 35 90 L 55 90 M 50 60 L 65 90 M 65 90 L 85 90 M 50 35 L 20 45 M 50 35 L 80 45" />';
      case 'weight_shift': return '<circle cx="60" cy="15" r="8" /><path d="M 60 23 L 50 55 M 50 55 L 40 90 M 50 55 L 70 90 M 60 35 L 30 40 M 60 35 L 85 45" />';
      case 'towel': return '<circle cx="25" cy="40" r="8" /><path d="M 25 48 L 25 80 M 25 80 L 80 80 M 25 55 L 75 75 M 75 75 L 80 80 M 25 80 L 15 80" />';
      case 'chair_ham': return '<rect x="10" y="45" width="25" height="40" stroke="none" fill="#e2e8f0" /><circle cx="25" cy="15" r="8" /><path d="M 25 23 L 25 50 M 25 50 L 40 50 L 40 90 M 25 50 L 75 90 M 25 35 L 45 45" />';
      case 'wall_ham': return '<rect x="65" y="10" width="10" height="80" stroke="none" fill="#e2e8f0" /><circle cx="20" cy="80" r="8" /><path d="M 28 80 L 60 80 M 60 80 L 60 25 M 60 80 L 90 80 M 40 80 L 50 65" />';
      case 'figure4': return '<rect x="30" y="45" width="25" height="40" stroke="none" fill="#e2e8f0" /><circle cx="40" cy="15" r="8" /><path d="M 40 23 L 40 50 M 40 50 L 60 50 L 60 90 M 40 50 L 70 45 L 60 70 M 40 35 L 60 40" />';
      case 'kneel_lunge': return '<circle cx="40" cy="20" r="8" /><path d="M 40 28 L 40 55 M 40 55 L 20 85 L 40 85 M 40 55 L 65 55 L 65 85 M 40 40 L 60 45 L 60 70" />';
      case 'broom': return '<circle cx="50" cy="15" r="8" /><path d="M 50 23 L 50 65 M 50 65 L 40 90 M 50 65 L 60 90 M 15 30 L 85 30 M 50 35 L 30 35 M 50 35 L 70 35" stroke-width="5" />';
      case 'slider': return '<rect x="70" y="55" width="15" height="30" stroke="none" fill="#e2e8f0" /><circle cx="35" cy="25" r="8" /><path d="M 35 33 L 55 60 M 55 60 L 20 85 M 55 60 L 75 60 L 75 85 M 35 45 L 75 55" />';
      default: return '<circle cx="50" cy="50" r="20" />';
    }
}

// --- STATE MANAGEMENT ---
let appState = 'home'; 
let level = 1;
let workoutsCompleted = 0;
let currentJoke = JOKES[Math.floor(Math.random() * JOKES.length)];

let currentRoutine = [];
let currentExIndex = 0;
let timeLeft = 0;
let timerActive = false;
let hasSwitched = false;
let isHalfwayPaused = false;

let isGeneratingMod = false;
let modText = "";
let isGeneratingJoke = false;

const appContainer = document.getElementById('app-container');

// --- GEMINI API ---
async function fetchGemini(prompt, systemPrompt = "You are a helpful, encouraging fitness and curling coach.") {
  const apiKey = ""; 
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] }
  };

  let delay = 1000;
  for (let i = 0; i < 5; i++) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't think of anything right now!";
    } catch (error) {
      if (i === 4) return "Sorry, I'm having trouble connecting right now. Please try again later!";
      await new Promise(res => setTimeout(res, delay));
      delay *= 2;
    }
  }
}

// --- LOGIC FUNCTIONS ---
function generateDailyRoutine(currentLevel) {
  const getRandom = arr => arr[Math.floor(Math.random() * arr.length)];
  const routine = [
    { ...getRandom(EXERCISE_POOL.flatFeet), category: 'Flat Feet Prep' },
    { ...getRandom(EXERCISE_POOL.balance), category: 'Balance Building' },
    { ...getRandom(EXERCISE_POOL.hamstrings), category: 'No-Toe-Touch Hamstrings' },
    { ...getRandom(EXERCISE_POOL.hips), category: 'Hip Mobility' },
    { ...getRandom(EXERCISE_POOL.curling), category: 'Curling Specific' }
  ];

  // Fisher-Yates shuffle
  for (let i = routine.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [routine[i], routine[j]] = [routine[j], routine[i]];
  }

  const extraTime = (currentLevel - 1) * 6; 
  return routine.map(ex => ({ ...ex, time: ex.baseTime + extraTime }));
}

function startWorkout() {
    currentRoutine = generateDailyRoutine(level);
    currentExIndex = 0;
    timeLeft = currentRoutine[0].time;
    modText = "";
    hasSwitched = false;
    isHalfwayPaused = false;
    timerActive = false;
    appState = 'workout';
    render();
}

function nextExercise() {
    modText = ""; 
    hasSwitched = false;
    isHalfwayPaused = false;
    if (currentExIndex < currentRoutine.length - 1) {
      currentExIndex++;
      timeLeft = currentRoutine[currentExIndex].time;
      timerActive = false;
      render();
    } else {
      finishWorkout();
    }
}

function toggleTimer() {
    if(timeLeft > 0) {
        timerActive = !timerActive;
        render();
    }
}

function resumeHalfway() {
    isHalfwayPaused = false;
    timerActive = true;
    render();
}

function finishWorkout() {
    workoutsCompleted++;
    if (workoutsCompleted % 3 === 0) level++;
    currentJoke = JOKES[Math.floor(Math.random() * JOKES.length)]; 
    appState = 'done';
    render();
}

function goHome() {
    appState = 'home';
    render();
}

async function requestMod() {
    const currentEx = currentRoutine[currentExIndex];
    isGeneratingMod = true;
    render(); // show loading
    
    const prompt = `My user is 45 years old, weighs 250 pounds, has flat feet, struggles with balance, and cannot touch their toes. 
    They are trying to do the exercise "${currentEx.name}" which is described as: "${currentEx.desc}". 
    Provide a brief, encouraging 1-2 sentence modification to make this exercise safer, easier, or more accessible for them.`;
    
    modText = await fetchGemini(prompt);
    isGeneratingMod = false;
    render(); // show result
}

async function generateJoke() {
    isGeneratingJoke = true;
    render(); // show loading
    
    const prompt = "Tell me a short, clean, funny dad joke about the sport of curling.";
    const response = await fetchGemini(prompt, "You are a comedian who loves curling.");
    currentJoke = response.replace(/^["']|["']$/g, '').trim();
    
    isGeneratingJoke = false;
    render(); // show result
}

// Timer Loop
setInterval(() => {
    if (!timerActive || timeLeft <= 0) return;
    
    const currentEx = currentRoutine[currentExIndex];
    const halfway = Math.floor(currentEx.time / 2);

    if (currentEx.requiresSwitch && timeLeft === halfway && !hasSwitched) {
        timerActive = false;
        hasSwitched = true;
        isHalfwayPaused = true;
        if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
        render();
        return; 
    }

    timeLeft--;
    if (timeLeft === 0) {
        timerActive = false;
        if ("vibrate" in navigator) navigator.vibrate(500);
    }
    render();
}, 1000);

// --- RENDERING ---
function render() {
    if (appState === 'home') {
        appContainer.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-500 via-indigo-600 to-purple-600 flex flex-col items-center justify-center p-6 text-white font-sans">
            <div class="w-full max-w-md bg-white/10 backdrop-blur-md rounded-3xl p-8 shadow-2xl border border-white/20 text-center">
                <div class="bg-yellow-400 text-blue-900 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                    ${ICONS.refresh}
                </div>
                <h1 class="text-4xl font-extrabold mb-2 tracking-tight">Sweep & Stretch</h1>
                <p class="text-blue-100 mb-8 text-lg">Your pre-curling flexibility prep.</p>
                
                <div class="flex justify-around mb-8 bg-black/20 rounded-2xl p-4">
                    <div class="text-center">
                        <p class="text-sm text-blue-200 uppercase tracking-wider font-semibold">Level</p>
                        <p class="text-3xl font-bold text-yellow-300">${level}</p>
                    </div>
                    <div class="w-px bg-white/20"></div>
                    <div class="text-center">
                        <p class="text-sm text-blue-200 uppercase tracking-wider font-semibold">Sessions</p>
                        <p class="text-3xl font-bold text-yellow-300">${workoutsCompleted}</p>
                    </div>
                </div>

                <div class="bg-white/10 p-4 rounded-xl mb-8 italic text-sm text-blue-50">
                    "${currentJoke}"
                </div>

                <button onclick="startWorkout()" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-blue-900 font-bold text-xl py-4 rounded-2xl shadow-xl transform transition active:scale-95 flex items-center justify-center gap-2">
                    ${ICONS.play} Let's Go!
                </button>
            </div>
        </div>`;
    } 
    else if (appState === 'workout') {
        const currentEx = currentRoutine[currentExIndex];
        const isLast = currentExIndex === currentRoutine.length - 1;
        const progressPercent = ((currentExIndex) / currentRoutine.length) * 100;
        
        let modSectionHTML = "";
        if (!modText && !isGeneratingMod) {
            modSectionHTML = `
                <button onclick="requestMod()" class="text-blue-600 font-semibold text-sm flex items-center gap-2 hover:text-blue-800 transition-colors bg-blue-50/50 px-4 py-2 rounded-xl">
                    ${ICONS.sparkles} ✨ Need an easier modification?
                </button>`;
        } else if (isGeneratingMod) {
             modSectionHTML = `
                <div class="flex items-center gap-2 text-blue-500 text-sm font-medium px-4 py-2">
                    ${ICONS.loader} Asking Coach Gemini...
                </div>`;
        } else {
             modSectionHTML = `
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-100 rounded-2xl p-5 flex items-start gap-4">
                  <div class="text-indigo-500 shrink-0 mt-1">${ICONS.sparkles}</div>
                  <div>
                    <p class="font-bold text-indigo-900 mb-1 text-sm uppercase tracking-wider">Coach's Modification</p>
                    <p class="text-indigo-800 text-base leading-relaxed">${modText}</p>
                  </div>
                </div>`;
        }

        const strokeDashoffset = 552 - (552 * timeLeft) / currentEx.time;
        const timerColorClass = isHalfwayPaused ? 'text-orange-500' : (timeLeft === 0 ? 'text-green-500' : 'text-blue-500');

        let timerCenterContent = "";
        if (isHalfwayPaused) {
            timerCenterContent = `
                <span class="text-2xl font-black text-orange-500 uppercase tracking-widest text-center px-4">Switch</span>
                <span class="text-2xl font-black text-orange-500 uppercase tracking-widest text-center px-4 mt-[-4px]">Sides</span>
            `;
        } else {
            timerCenterContent = `
                <span class="text-6xl font-black tabular-nums ${timeLeft === 0 ? 'text-green-500' : 'text-neutral-800'}">${timeLeft}</span>
                <span class="text-neutral-400 font-bold uppercase tracking-widest text-xs mt-1">Seconds</span>
            `;
        }

        let buttonsHTML = "";
        if (isHalfwayPaused) {
             buttonsHTML = `
                <button onclick="resumeHalfway()" class="flex-1 py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 bg-gradient-to-r from-orange-400 to-orange-500 text-white shadow-lg shadow-orange-200 transform transition active:scale-95 animate-pulse">
                  ${ICONS.play} Resume Other Side
                </button>
             `;
        } else {
            const btnClass = timeLeft === 0 
                ? 'bg-neutral-200 text-neutral-400 cursor-not-allowed' 
                : timerActive 
                    ? 'bg-red-100 text-red-600 border-2 border-red-200' 
                    : 'bg-green-100 text-green-700 border-2 border-green-200';
            const btnIcon = timerActive ? ICONS.pause : ICONS.play;
            const btnText = timerActive ? "Pause" : "Start";
            
            const nextClass = timeLeft === 0 
                ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' 
                : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200';

            buttonsHTML = `
                <button onclick="toggleTimer()" ${timeLeft === 0 ? 'disabled' : ''} class="flex-1 py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 transition transform active:scale-95 ${btnClass}">
                    ${btnIcon} ${btnText}
                </button>
                <button onclick="nextExercise()" class="flex-1 py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 transition transform active:scale-95 ${nextClass}">
                    ${isLast ? 'Finish' : 'Next'} ${ICONS.chevronRight}
                </button>
            `;
        }

        appContainer.innerHTML = `
        <div class="min-h-screen bg-neutral-50 flex flex-col font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative">
            <div class="bg-white px-6 pt-12 pb-4 shadow-sm z-10">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-neutral-400 font-bold tracking-wider text-sm uppercase">Exercise ${currentExIndex + 1} of ${currentRoutine.length}</p>
                    <button onclick="goHome()" class="text-neutral-400 hover:text-neutral-600 font-semibold text-sm">Cancel</button>
                </div>
                <div class="w-full bg-neutral-200 h-2 rounded-full overflow-hidden">
                    <div class="bg-blue-500 h-full transition-all duration-500 ease-out" style="width: ${progressPercent}%"></div>
                </div>
            </div>

            <div class="flex-1 px-6 py-8 flex flex-col justify-between overflow-y-auto">
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <span class="inline-block bg-pink-100 text-pink-700 font-bold px-3 py-1 rounded-full text-xs uppercase tracking-wider">
                            ${currentEx.category}
                        </span>
                        ${currentEx.requiresSwitch ? `
                        <span class="flex items-center gap-1 text-orange-500 font-bold text-xs uppercase bg-orange-100 px-2 py-1 rounded-full">
                            ${ICONS.arrowRightLeft} 2 Sides
                        </span>` : ''}
                    </div>
                    
                    <h2 class="text-3xl font-extrabold text-neutral-800 mb-6 leading-tight">${currentEx.name}</h2>

                    <div class="w-full h-48 mb-6 rounded-2xl bg-white border-2 border-dashed border-blue-200 flex items-center justify-center p-4">
                        <svg viewBox="0 0 100 100" class="w-full h-full stroke-blue-600 fill-transparent" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                            ${getSketchPath(currentEx.id)}
                        </svg>
                    </div>

                    <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5 flex items-start gap-4">
                        <div class="text-blue-500 shrink-0 mt-1">${ICONS.info}</div>
                        <p class="text-neutral-700 text-lg leading-relaxed">${currentEx.desc}</p>
                    </div>

                    <div class="mt-4 min-h-[60px]">
                        ${modSectionHTML}
                    </div>
                </div>

                <div class="mt-8 flex flex-col items-center">
                    <div class="relative">
                        <svg class="w-48 h-48 transform -rotate-90">
                            <circle cx="96" cy="96" r="88" stroke="currentColor" stroke-width="8" fill="transparent" class="text-neutral-200" />
                            <circle cx="96" cy="96" r="88" stroke="currentColor" stroke-width="8" fill="transparent" stroke-dasharray="552" stroke-dashoffset="${strokeDashoffset}" stroke-linecap="round" class="timer-circle ${timerColorClass}" />
                        </svg>
                        <div class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center">
                            ${timerCenterContent}
                        </div>
                    </div>

                    <div class="flex gap-4 mt-8 w-full">
                        ${buttonsHTML}
                    </div>
                </div>
            </div>
        </div>`;
    }
    else if (appState === 'done') {
        const jokeBtnContent = isGeneratingJoke 
            ? `${ICONS.loader} Thinking...` 
            : `${ICONS.sparkles} ✨ Generate New Joke`;

        appContainer.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-green-400 to-emerald-600 flex flex-col items-center justify-center p-6 text-white font-sans">
            <div class="w-full max-w-md bg-white/10 backdrop-blur-md rounded-3xl p-8 shadow-2xl border border-white/20 text-center">
                <div class="bg-white text-green-500 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    ${ICONS.checkCircle}
                </div>
                <h1 class="text-4xl font-extrabold mb-2 tracking-tight">Great Job!</h1>
                <p class="text-green-100 mb-6 text-lg">You're one step closer to sweeping the competition on the ice.</p>
                
                <div class="bg-black/20 rounded-2xl p-6 mb-8 text-left flex items-start gap-4">
                    <div class="text-yellow-300 shrink-0">${ICONS.smile}</div>
                    <div class="flex-1">
                        <p class="font-bold text-white mb-1">Coach's Joke of the Day:</p>
                        <p class="text-green-50 italic mb-4">"${currentJoke}"</p>
                        <button onclick="generateJoke()" ${isGeneratingJoke ? 'disabled' : ''} class="bg-white/20 hover:bg-white/30 text-white text-sm font-semibold py-2 px-4 rounded-xl flex items-center gap-2 transition-colors disabled:opacity-50">
                            ${jokeBtnContent}
                        </button>
                    </div>
                </div>

                <button onclick="goHome()" class="w-full bg-white text-green-700 font-bold text-xl py-4 rounded-2xl shadow-xl transform transition active:scale-95">
                    Back to Home
                </button>
            </div>
        </div>`;
    }
}

// Initial Render
render();

</script>
</body>
</html>
